\chapter{Implement\'{a}cia}
\label{ch:impl}

Táto kapitola sa venuje implementácii aplikácie. Konkrétne popíšeme úlohy
jednotlivých komponentov, detailne vysvetlíme fungovanie a správanie celého
systému, pozrieme sa na zaujímavé časti kódu a rozoberieme rôzne problémy,
na ktoré sme počas implementácie narazili.

\section{Master}
\label{sec:master}

\subsection{Spracov\'{a}vanie BUILD s\'{u}borov}
\label{sec:master:buildfile}

BUILD súbory obsahujú popis projektu z pohľadu nášho systému. Súbory štandardne
pomenúvame \texttt{build.yaml} a ich obsah je vo formáte YAML\@. Na spracovanie
formátu YAML v jazyku Go sme sa rozhodli použiť knižnicu
\texttt{simpleyaml}\footnote{\url{https://github.com/smallfish/simpleyaml}}.
Táto knižnica prečíta text vo formáte YAML a umožní s údajmi pracovať pomocou
štandardných údajových štruktúr jazyka Go, ako je napríklad integer, string,
pole alebo mapa.

Listing~\ref{lst:client:parsefile} obsahuje zdrojový kód funkcie ParseFile, ktorá
s použitím knižnice simpleyaml spracúva BUILD súbory a vytvára z nich objekty
reprezentujúce ciele.

\begin{listing}[H]
  \inputminted[frame=lines,framesep=2mm,linenos,fontsize=\scriptsize,firstline=44,lastline=75]{go}{/home/pepol/src/imterra/forge/client/target/parse.go}
  \caption[Funkcia ParseFile]{Funkcia ParseFile, ktorá spracúva BUILD súbory.}
  \label{lst:client:parsefile}
\end{listing}

\subsection{Reprezentácia cieľov, rozhranie Target}
\label{sec:master:target}

\begin{listing}[H]
  \inputminted[frame=lines,framesep=2mm,linenos,fontsize=\scriptsize,firstline=8,lastline=14]{go}{/home/pepol/src/imterra/forge/client/target/target.go}
  \caption[Rozhranie Target]{Rozhranie popisujúce objekt reprezentujúci cieľ kompilácie.}
  \label{lst:client:target}
\end{listing}

Každý typ cieľa reprezentujeme ako triedu implementujúcu rozhranie typu Target.
Jeho definícia je uvedená v listingu~\ref{lst:client:target}. Postupne popíšeme
jednotlivé metódy.

\subsubsection{GetName}
Metóda vracajúca názov daného cieľa ako je uvedený v BUILD súbore.

\subsubsection{GetSources}
Táto metóda vráti zoznam zdrojových súborov daného cieľa. V prípade neexistenie
takýchto súborov, metóda vráti prázdne pole. Zdrojové súbory sú v BUILD súbore
špecifikované ako zoznam \texttt{sources}.

Medzi zdrojové súbory patria hlavne zdrojové súbory programu v určitom
programovacom jazyku, ktoré je potrebné skompilovať. Sú to najčastejšie textové
súbory so špecifickou príponou.

\subsubsection{GetResources}
Metóda vracajúca zoznam súborov prostriedkov. Funkcionalita je rovnaká ako v
prípade metódy GetSources. Súbory prostriedkov sú špecifikované ako zoznam
\texttt{resources}.

Medzi súbory prostriedkov patria súbory, ktoré je potrebne spracovať iným spôsobom
ako zdrojový kód programu. Ako príklad uvádzame ikony, obrázky alebo videá v
prípade počítačových hier.

\subsubsection{GetDependencies}
Táto metóda vráti zoznam cieľov, na ktorých aktuálny cieľ závisí. Každý člen
tohto zoznamu implementuje rozhranie Target. Pomocou tejto metódy pristupujeme
k vzniknutému grafu závislostí.

\subsubsection{GetOutputFile}
Táto metóda vráti referenciu na vygenerovaný súbor (typu GeneratedFile, ktorý
implementuje rozhranie File). Pomocou tohto súboru pristupujeme ku bipartitnému
grafu súborov a akcií.

\subsection{Trieda LibCTarget}
\label{sec:master:libctarget}

Trieda LibCTarget implementuje cieľ typu \verb!lib_c!, ktorý sa používa na
kompiláciu zdrojových kódov jazyku C, ktoré potom môžu využívať rôzne aplikácie.

Trieda LibCTarget vygeneruje staticky linkovanú knižnicu obsahujúcu skompilované
zdrojové súbory. Takto vygenerovanú knižnicu môžeme použiť vo fáze linkovania
akejkoľvek aplikácie.

\begin{figure}[h]
  \centerline{\includegraphics[width=0.6\textwidth]{images/libctarget}}
  \caption[Graf akcií pre typ LibCTarget]{Ukážka grafu akcií vytvoreného pre typ
  LibCTarget.}
  \label{img:libctarget}
\end{figure}


Ukážka vytvoreného grafu akcií pre OS Linux je znázornená na obrázku~\ref{img:libctarget},
skladá sa z dvoch akcií: V prvej fáze je každý zdrojový súbor skompilovaný
do objektového súboru jazyka C\footnote{kompilátor jazyka C sa štandardne označuje
pomocou písmen CC, z anglického C Compiler} a následne sú všetky takto skompilované súbory
vložené do archívu vytvoreného programom ar(1)\footnote{\url{http://linux.die.net/man/1/ar}}.

\subsection{Trieda AppCTarget}
\label{sec:master:appctarget}

Táto trieda reprezentuje cieľ typu \verb!app_c!, ktorý sa používa na špecifikáciu
spustiteľného programu / aplikácie napísanej v jazyku C.

Trieda AppCTarget vygeneruje staticky linkovaný spustiteľný súbor obsahujúci
skompilované zdrojové kódy, zlinkované s knižnicami uvedenými ako závislosťami.

\begin{figure}[h]
  \centerline{\includegraphics[width=0.6\textwidth]{images/appctarget}}
  \caption[Graf akcií pre typ AppCTarget]{Ukážka grafu akcií pre typ AppCTarget,
  súbor c.a je výstupom cieľa \texttt{c} typu LibCTarget.}
  \label{img:appctarget}
\end{figure}

Na obrázku~\ref{img:appctarget} sa nachádza ukážka grafu akcií pre AppCTarget
v prostredí OS Linux. Tento graf je tvorený akciami kompilácie (pre zdrojové
súbory) a linkovania\footnote{štandardný linker v OS UNIX a Linux má názov ld,
z ktorého vzniklo označenie LD} výsledných objektov s knižnicami.

\subsection{Prevod grafu cie\v{l}ov do grafu akci\'{i}}
\label{sec:master:target2action}

Ako uvádzame v časti~\ref{sec:master:target}, metóda GetOutputFile rozhrania Target
je zodpovedná za vytvorenie správneho grafu akcií pre daný cieľ. Graf akcií je
bipartitný graf zlozžený z objektov rozhrania Action (akcie, úlohy) a objektov
rozhrania File (zdrojové alebo vygenerované súbory).

Nasleduje popis funkcionality metódy pre jednotlivé triedy:

\subsubsection{LibCTarget}
V metóde prechádzame zoznam mien zdrojových súborov a z každého vytvoríme objekt typu
SourceFile (implementujúci rozhranie File) a jeho ekvivalentný objektový súbor
typu GeneratedFile (taktiež implementujúci rozhranie File). Následne pre každú
takúto dvojicu zdrojového a z neho vygenerovaného súboru vytvoríme akciu typu
CompileCAction (rozhrania Action), ktorej vstupným súborom bude zdrojový
súbor a výstupným vygenerovaný objektový.

Následne vytvoríme súbor reprezentujúci vytváranú knižnicu ako celok (typu GeneratedFile),
ktorý bude výstupným súborom prislúchajúcej akcie typu ArLinkAction (rozhrania Action).
V predchádzajúcom kroku vygenerované objektové súbory použijeme ako vstupné
súbory pre túto akciu.

\subsubsection{AppCTarget}
Metóda sa na zdrojových súboroch správa rovnako ako v triede LibCTarget. Po
vytvorení takejto knižnice prejdeme rekurzívne závislosti a ich výstupné
súbory, spolu s práve vytvorenou knižnicou predáme ako vstupné súbory
akcii LinkAction (rozhrania Action), ktorej výstupným súborom (typu GeneratedFile)
je požadovaná spustiteľná aplikácia.

\subsection{Distrib\'{u}cia akci\'{i}}
\label{sec:master:distribution}


\section{Slave}
\label{sec:slave}

Slave komponent je určený na vykonávanie úloh. Implementujeme ho v jazyku Go
ako RPC\footnote{Remote Procedure Call - vzdialené volanie procedúr} server.
V rámci tohto serveru poskytujeme niekoľko implementovaných RPC služieb,
z ktorých každá implementuje pomocou svojich procedúr určitú časť funkcionality.

V nasledujúcich častiach si popíšeme jednotlivé služby a procedúry ktoré
poskytujú.

\subsection{RPC služba Task}
\label{sec:slave:rpc:action}

Služba Task poskytuje procedúry na vykonávanie úloh priamo súvisiacich so
splnením cieľa. Tieto úlohy su ekvivalentné akciám na strane Master komponentu.

\begin{listing}[H]
  \inputminted[frame=lines,framesep=2mm,linenos,fontsize=\scriptsize,firstline=8,lastline=12]{go}{/home/pepol/src/imterra/forge/proto/proto.go}
  \caption[Argumenty služby Task]{Štruktúra špecifikujúca argumenty procedúr RPC služby Task.}
  \label{lst:rpc:action:args}
\end{listing}

\begin{listing}[H]
  \inputminted[frame=lines,framesep=2mm,linenos,fontsize=\scriptsize,firstline=14,lastline=17]{go}{/home/pepol/src/imterra/forge/proto/proto.go}
  \caption[Návratová hodnota služby Task]{Štruktúra špecifikujúca návratovú hodnotu procedúr RPC služby Task.}
  \label{lst:rpc:action:response}
\end{listing}

Každá z týchto procedúr dostáva ako argumenty meno akcie, zoznam vstupných súborov
s cestou relatívnou ku koreňovému priečinku systému, ich SHA512 kontrolným súčtom a informáciu, či volajúci
vyžaduje poslanie výsledného súboru. Implementáciu uvádzame v listingu~\ref{lst:rpc:action:args}.

Výsledkom volania procedúry je výstup, ktorý vznikol počas jej vykonávania a,
pokiaľ volajúci o to požiadal, obsah vzniknutého súboru. Implementáciu uvádzame
v listingu~\ref{lst:rpc:action:response}.

Pri spúšťaní Slave komponentu umožňujeme používateľovi zvoliť, koľko úloh súčasne sa
môže vykonávať pomocou argumentu \texttt{jobs}. Ako prednastavenú hodnotu sme zvolili počet
CPU ktoré sa na danom počítači nachádzajú. Tento počet ovplyvňuje počet súčasne
aktívnych procedúr služby Task, ktoré na zabezpečenie používajú semafór implementovaný
pomocou atribútu objektu služby. Funkcionalitu semafóru sme dosiahli pomocou
dátového typu channel, ktorému určujeme veľkosť na základe hodnoty argumentu \texttt{jobs}.
Zároveň u každej procedúry tejto služby vyžadujeme, aby pri spustení zapísala do semafóru
údaje, akcia ktorá v jazyku Go blokuje, ak je objekt naplnený, a po skončení vykonávania,
úspešnom ako aj neúspešnom, hodnotu zo semafóru prečítala a tým uvoľnila miesto pre
vykonávanie ďalších procedúr.

\begin{listing}[H]
  \inputminted[frame=lines,framesep=2mm,linenos,fontsize=\scriptsize,firstline=9,lastline=22]{go}{/home/pepol/src/imterra/forge/worker/tasks/util.go}
  \caption{Funkcia na prípravu argumentov pre volanie príkazu.}
  \label{lst:rpc:processinputs}
\end{listing}

\begin{listing}[H]
  \inputminted[frame=lines,framesep=2mm,linenos,fontsize=\scriptsize,firstline=24,lastline=40]{go}{/home/pepol/src/imterra/forge/worker/tasks/util.go}
  \caption{Funkcia na prípravu odpovede služby Task.}
  \label{lst:rpc:prepareresp}
\end{listing}

V nasledujúcich častiach popisujeme jednotlivé procedúry služby Task. V týchto
procedúrach sú činnosti ako príprava odpovede na odoslanie (listing~\ref{lst:rpc:prepareresp})
alebo príprava argumentov pre volanie externého príkazu (listing~\ref{lst:rpc:processinputs})
často opakované, preto sme sa rozhodli ich implementácie uviesť samostatne.

\subsubsection{CompileC}

Táto procedúra vykonáva kompiláciu C súboru do objektového súboru. Vzhľadom na to,
že táto akcia vyžaduje iba 1 zdrojový súbor, rozhodli sme sa signalizovať chybu
kedykoľvek na vstupe dostaneme viac súborov.

\begin{listing}[H]
  \inputminted[frame=lines,framesep=2mm,linenos,fontsize=\scriptsize,firstline=20,lastline=47]{go}{/home/pepol/src/imterra/forge/worker/tasks/tasks.go}
  \caption[Implementácia kompilácie jazyka C]{Implementácia úlohy kompilácie programovacieho jazyka C pre OS Linux.}
  \label{lst:rpc:compilec}
\end{listing}


V listingu~\ref{lst:rpc:compilec} sme ukázali implementáciu procedúry pre OS Linux
a kompilátor GNU GCC\@. Táto procedúra volá externý príkaz s predpripravenými parametrami,
ktorého výstup posunie v návratovej hodnote volajúcemu.

\subsection{Komunika\v{c}n\'{y} protokol}
\label{sec:slave:protocol}

\subsection{Z\'{i}skavanie zdrojov\'{y}ch s\'{u}borov}
\label{sec:slave:retrieval}

\subsection{Vykon\'{a}vanie akcie}
\label{sec:slave:execution}

\subsection{Poskytovanie vygenerovan\'{y}ch s\'{u}borov}
\label{sec:slave:provision}
